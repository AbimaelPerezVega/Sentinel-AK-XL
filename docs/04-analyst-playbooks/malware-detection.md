# SOC Analyst Playbook: Malware Detection

## Overview
- **Alert Type**: Malware Detection / File Integrity Monitoring
- **Severity Level**: High (Level 8-12)
- **MITRE ATT&CK Tactic**: Initial Access, Execution, Persistence
- **Response Time**: < 10 minutes for critical systems
- **Escalation**: Immediate if confirmed malware on production systems

## Detection Criteria

### Wazuh Rule Triggers
- **Rule 550**: File Integrity Monitoring - File added
- **Rule 554**: File Integrity Monitoring - File modified  
- **Custom Rule 100004**: Sysmon Event 11 - File creation
- **VirusTotal Integration**: Positive malware detection

### Alert Sources
- **FIM (Syscheck)**: File changes in monitored directories
- **VirusTotal API**: Hash reputation lookup
- **Sysmon Events**: Process creation and file operations
- **Custom Rules**: Suspicious file extensions and locations

### Monitored Directories
```
/var/ossec/data/fimtest/          # Test simulation directory
/tmp/                             # Temporary files
/var/www/                         # Web server files
/home/*/Downloads/                # User download directories
C:\Windows\Temp\                  # Windows temp (if monitoring Windows)
C:\Users\*/Downloads\             # Windows user downloads
```

### Suspicious Indicators
- **File Extensions**: .exe, .scr, .bat, .cmd, .pif, .com in unusual locations
- **VirusTotal Scores**: Positive detection by 2+ engines
- **File Names**: Known malware naming patterns
- **Hash Matches**: Known malicious file hashes

## Initial Triage Steps

### 1. Alert Validation (2-3 minutes)
- [ ] **Open alert in Wazuh Dashboard**
  ```
  Navigation: Security Events → Alerts → Filter by rule.groups:syscheck OR rule.groups:virustotal
  ```
- [ ] **Verify file details**:
  - File path and name
  - File size and permissions
  - Creation/modification time
  - User context of file operation

### 2. VirusTotal Analysis (3-5 minutes)
- [ ] **Check VirusTotal results**:
  ```
  Query: rule.groups:"virustotal" AND data.virustotal.found:"1"
  ```
- [ ] **Review detection metrics**:
  - `data.virustotal.positives`: Number of engines detecting malware
  - `data.virustotal.total`: Total engines scanned
  - `data.virustotal.malicious`: Malicious verdict count
  - `data.virustotal.permalink`: Link to full VT report

### 3. File Integrity Context (3 minutes)
- [ ] **Review syscheck details**:
  ```
  Query: rule.groups:"syscheck" AND syscheck.path:"[FILE_PATH]"
  ```
- [ ] **Analyze file changes**:
  - `syscheck.event`: added, modified, deleted
  - `syscheck.md5_after`: File hash after change
  - `syscheck.size_after`: File size
  - `syscheck.changed_attributes`: What changed

## Investigation Workflow

### Phase 1: File Analysis (5-10 minutes)

#### Elasticsearch Queries
```json
# Get all FIM events for specific file
GET /sentinel-logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"rule.groups.keyword": "syscheck"}},
        {"term": {"syscheck.path.keyword": "/path/to/suspicious/file"}},
        {"range": {"@timestamp": {"gte": "now-24h"}}}
      ]
    }
  },
  "sort": [{"@timestamp": {"order": "asc"}}]
}
```

```json
# Get VirusTotal results for file hash
GET /sentinel-logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"rule.groups.keyword": "virustotal"}},
        {"term": {"data.virustotal.source.md5.keyword": "FILE_HASH"}},
        {"term": {"data.virustotal.found.keyword": "1"}}
      ]
    }
  }
}
```

#### File Hash Investigation
- [ ] **Extract file hashes**:
  - MD5: `syscheck.md5_after` or `data.virustotal.source.md5`
  - SHA1: `syscheck.sha1_after` or `data.virustotal.source.sha1`
  - SHA256: `syscheck.sha256_after`

### Phase 2: Process Context Analysis (10 minutes)

#### Sysmon Process Correlation
```json
# Find process that created the file (if Sysmon available)
GET /wazuh-alerts-*/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"rule.id": "100004"}},
        {"term": {"win.eventdata.targetFilename.keyword": "FILE_PATH"}},
        {"range": {"@timestamp": {"gte": "now-1h"}}}
      ]
    }
  }
}
```

#### Process Tree Analysis
- [ ] **Identify parent process**:
  - Process that created/modified the file
  - Command line arguments used
  - User context of execution
- [ ] **Check process reputation**:
  - Known legitimate vs suspicious processes
  - Process location and signature verification

### Phase 3: Lateral Movement Detection (10 minutes)

#### Network Activity Correlation
- [ ] **Check for network connections**:
  ```
  Query: agent.name:"AFFECTED_SYSTEM" AND rule.groups:"sysmon_network_connection"
  ```
- [ ] **Look for suspicious network activity**:
  - Outbound connections to unknown IPs
  - DNS queries for suspicious domains
  - Data exfiltration patterns

#### System-wide Impact Assessment
- [ ] **Search for similar files**:
  ```
  Query: syscheck.md5_after:"MALWARE_HASH" OR syscheck.sha1_after:"MALWARE_HASH"
  ```
- [ ] **Check other systems**:
  - Same hash on multiple endpoints
  - Similar file names or paths
  - Coordinated file creation times

## Escalation Criteria

### Escalate to Level 2 Analyst if:
- [ ] **High VirusTotal detection rate** (5+ engines)
- [ ] **File in critical system directory** (system32, boot folders)
- [ ] **Multiple files with same characteristics** detected
- [ ] **Network activity** associated with file creation
- [ ] **Process injection or hollowing** detected

### Escalate to Incident Response if:
- [ ] **Confirmed malware on production system**
- [ ] **Evidence of data exfiltration**
- [ ] **Ransomware indicators** (file encryption patterns)
- [ ] **Advanced persistent threat** indicators
- [ ] **Critical infrastructure** systems affected

## Response Actions

### Immediate Actions (< 10 minutes)

#### 1. File Quarantine
```bash
# Move suspicious file to quarantine
sudo mv /path/to/suspicious/file /var/quarantine/$(date +%Y%m%d_%H%M%S)_suspicious_file

# Or if unable to move, isolate the directory
sudo chmod 000 /path/to/suspicious/file
```

#### 2. Process Termination
```bash
# If malicious process is running
sudo pkill -f "suspicious_process_name"

# Check for running processes with suspicious characteristics
ps aux | grep -E "(suspicious_pattern|malware_name)"
```

#### 3. System Isolation (if necessary)
- [ ] **Disconnect from network** if active malware detected
- [ ] **Prevent lateral movement** by blocking affected system
- [ ] **Preserve evidence** for forensic analysis

### Short-term Actions (< 1 hour)

#### 1. Enhanced Monitoring
```bash
# Increase FIM monitoring frequency
# Add additional directories to monitoring
# Enable real-time scanning if available
```

#### 2. Threat Intelligence
- [ ] **Submit hash to threat intelligence platforms**:
  - VirusTotal (if not already done)
  - Hybrid Analysis
  - Joe Sandbox
  - Internal threat intelligence feeds

#### 3. System Hardening
- [ ] **Update antivirus signatures**
- [ ] **Apply security patches** if vulnerability exploited
- [ ] **Review and update** FIM monitoring rules
- [ ] **Implement additional controls** based on attack vector

### Long-term Actions (< 24 hours)

#### 1. Forensic Analysis
- [ ] **Create system image** for detailed analysis
- [ ] **Extract and analyze** malware sample
- [ ] **Reverse engineer** attack methodology
- [ ] **Identify attack vector** and entry point

#### 2. System Recovery
- [ ] **Clean infected systems** using appropriate tools
- [ ] **Restore from clean backups** if necessary
- [ ] **Rebuild systems** if heavily compromised
- [ ] **Verify system integrity** before reconnecting

#### 3. Lessons Learned
- [ ] **Document attack timeline** and methodology
- [ ] **Update detection rules** based on findings
- [ ] **Improve monitoring** coverage
- [ ] **Security awareness training** if needed

## Tools and Queries

### Wazuh Queries
```bash
# File integrity monitoring alerts
rule.groups:"syscheck" AND syscheck.event:"added"

# VirusTotal detections
rule.groups:"virustotal" AND data.virustotal.found:"1"

# Sysmon file creation events
rule.id:"100004" AND win.eventdata.targetFilename:*

# High-risk file extensions
syscheck.path:*.exe OR syscheck.path:*.scr OR syscheck.path:*.bat
```

### System-Level Investigation
```bash
# Check file details
ls -la /path/to/suspicious/file
file /path/to/suspicious/file
md5sum /path/to/suspicious/file
sha256sum /path/to/suspicious/file

# Check file attributes and permissions
stat /path/to/suspicious/file
lsattr /path/to/suspicious/file  # Linux extended attributes

# Check for file execution
ps aux | grep "suspicious_file"
lsof | grep "suspicious_file"

# Check recent file modifications
find /path -newer /path/to/suspicious/file -ls
```

### VirusTotal Manual Check
```bash
# Check hash reputation manually
curl -X GET "https://www.virustotal.com/vtapi/v2/file/report" \
  -d "apikey=YOUR_API_KEY" \
  -d "resource=FILE_HASH"
```

## Evidence Collection

### File Evidence
- [ ] **Preserve original file** in quarantine
- [ ] **Document file metadata** (size, dates, permissions)
- [ ] **Capture file hashes** (MD5, SHA1, SHA256)
- [ ] **Screenshot of file properties**

### System Evidence
- [ ] **Process list** at time of detection
- [ ] **Network connections** during incident
- [ ] **System logs** related to file activity
- [ ] **Registry changes** (Windows systems)

### Wazuh Evidence
- [ ] **Export FIM alerts** for affected files
- [ ] **Export VirusTotal results**
- [ ] **Capture Sysmon events** if available
- [ ] **Document rule matches** and signatures

## Common False Positives

### Legitimate Software Updates
- **Scenario**: Software auto-updates creating new files
- **Validation**: Check file signatures and publisher
- **Tuning**: Whitelist legitimate software directories

### Development Activities
- **Scenario**: Developers compiling code or testing
- **Validation**: Verify with development team
- **Tuning**: Exclude development directories during work hours

### System Maintenance
- **Scenario**: Scheduled maintenance creating temporary files
- **Validation**: Check maintenance schedules
- **Tuning**: Adjust monitoring during maintenance windows

## Integration with Other Playbooks
- [Network Anomaly Investigation](./network-anomalies.md) - For network-based malware
- [Process Analysis](./process-analysis.md) - For process-based threats
- [Data Exfiltration](./data-exfiltration.md) - For data theft scenarios
- [Incident Response](../investigation-workflows/incident-response.md) - For major breaches

## Detection Rule Improvements

### Custom Rule Suggestions
```xml
<!-- Enhanced VirusTotal rule for high-confidence detections -->
<rule id="100201" level="12">
  <if_sid>657</if_sid>
  <field name="virustotal.positives">^[5-9]|[1-9][0-9]</field>
  <description>VirusTotal: High confidence malware detection ($(virustotal.positives)/$(virustotal.total))</description>
  <group>virustotal,malware,high_confidence</group>
  <mitre><id>T1105</id></mitre>
</rule>

<!-- Suspicious file extensions in unusual locations -->
<rule id="100202" level="10">
  <if_sid>550</if_sid>
  <match>\.exe$|\.scr$|\.bat$|\.cmd$|\.pif$|\.com$</match>
  <field name="file">/tmp/|/var/tmp/|/home/.*/Downloads/</field>
  <description>Suspicious executable in unusual location: $(file)</description>
  <group>syscheck,malware,suspicious_location</group>
  <mitre><id>T1204</id></mitre>
</rule>
```

## References
- [NIST Cybersecurity Framework - Detect Function](https://www.nist.gov/cyberframework)
- [MITRE ATT&CK: Initial Access](https://attack.mitre.org/tactics/TA0001/)
- [SANS Digital Forensics](https://www.sans.org/white-papers/1060/)
- [Wazuh File Integrity Monitoring](https://documentation.wazuh.com/current/user-manual/capabilities/file-integrity/)
- [VirusTotal API Documentation](https://developers.virustotal.com/reference)

---
**Last Updated**: September 2025  
**Version**: 1.0  
**Approved By**: SOC Manager