# Malware Drop Simulation Guide

## Overview

The Malware Drop Simulator creates clean and malicious (EICAR) files in directories monitored by Wazuh FIM to test File Integrity Monitoring and VirusTotal integration.

## Quick Setup

### 1. Copy Script to Container
```bash
# Copy simulator to Wazuh manager container
docker cp scenarios-simulator/malware-drop/malware-drop-simulator.sh \
  sentinel-wazuh-manager:/usr/local/bin/malware-drop-simulator

# Make executable
docker exec -it sentinel-wazuh-manager chmod +x /usr/local/bin/malware-drop-simulator
```

### 2. Verify Target Directory
```bash
# Check if FIM directory exists
docker exec -it sentinel-wazuh-manager ls -la /var/ossec/data/fimtest/

# Create if needed (should already exist from installation)
docker exec -it sentinel-wazuh-manager mkdir -p /var/ossec/data/fimtest
```

## Basic Usage

### Generate Mixed Files (Default)
```bash
# Create 10 files (7 clean, 3 malicious EICAR)
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator
```

### Specify File Count and Ratio
```bash
# Create 15 files with 1 in 5 being malicious
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator 15 5

# Create 8 files with 1 in 2 being malicious (higher risk scenario)
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator 8 2
```

## Training Scenarios

### Scenario 1: Basic FIM Testing
```bash
# Generate small batch for initial testing
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator 5 3

# Wait 2-3 minutes for processing
sleep 180

# Check for FIM alerts in Wazuh
# Expected: 5 syscheck alerts (file added events)
```

### Scenario 2: VirusTotal Integration Test
```bash
# Generate files with higher malicious ratio
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator 6 2

# Monitor VirusTotal integration
# Expected: EICAR detections should appear in Kibana within 5 minutes
```

### Scenario 3: Mass File Drop (APT Simulation)
```bash
# Simulate large-scale file deployment
docker exec -it sentinel-wazuh-manager /usr/local/bin/malware-drop-simulator 20 4

# Expected: Multiple FIM alerts, VirusTotal lookups, potential rule correlation
```

## Verification Commands

### Check Created Files
```bash
# List all files in FIM directory
docker exec -it sentinel-wazuh-manager ls -la /var/ossec/data/fimtest/

# Count clean vs malicious files
docker exec -it sentinel-wazuh-manager bash -c "
  echo 'Clean files:' && grep -l 'corporate document' /var/ossec/data/fimtest/* | wc -l
  echo 'EICAR files:' && grep -l 'EICAR-STANDARD' /var/ossec/data/fimtest/* | wc -l
"
```

### Verify FIM Detection
```bash
# Check Wazuh logs for syscheck events
docker exec -it sentinel-wazuh-manager tail -f /var/ossec/logs/ossec.log | grep syscheck

# Query Elasticsearch for FIM alerts
curl -s "localhost:9200/wazuh-alerts-*/_search?q=rule.groups:syscheck&size=10&sort=@timestamp:desc" | \
  jq '.hits.hits[]._source | {timestamp: .timestamp, file: .syscheck.path, event: .syscheck.event}'
```

### Check VirusTotal Integration
```bash
# Query for VirusTotal detections
curl -s "localhost:9200/sentinel-logs-*/_search" \
  -H 'Content-Type: application/json' \
  -d '{
    "query": {"term": {"rule.groups.keyword": "virustotal"}},
    "size": 5,
    "sort": [{"@timestamp": {"order": "desc"}}]
  }' | jq '.hits.hits[]._source | {file: .data.virustotal.source.file, found: .data.virustotal.found, positives: .data.virustotal.positives}'
```

## File Types Generated

### Clean Files
- `report-final.docx` - Corporate document
- `data_analysis.xlsx` - Spreadsheet file  
- `meeting_notes.txt` - Text file
- `config.json` - Configuration file
- `backup.sql` - Database backup

### Malicious Files (EICAR)
- `Free-Games-Installer.exe` - Fake game installer
- `flashplayer_update.exe` - Fake Flash update
- `Bitcoin-Generator.exe` - Cryptocurrency scam
- `document.scr` - Screen saver malware
- `java_update.jar` - Fake Java update

## Expected Detection Flow

1. **File Creation** → FIM detects new files
2. **Hash Calculation** → Wazuh calculates MD5/SHA1
3. **VirusTotal Lookup** → Automatic hash submission
4. **Alert Generation** → Rules trigger based on results
5. **Log Enrichment** → Logstash adds context
6. **Dashboard Update** → Kibana visualizations refresh

## Cleanup

### Remove All Test Files
```bash
# Clean up simulation files
docker exec -it sentinel-wazuh-manager rm -f /var/ossec/data/fimtest/*

# Verify cleanup
docker exec -it sentinel-wazuh-manager ls -la /var/ossec/data/fimtest/
```

### Check Simulation Logs
```bash
# View malware simulation logs
docker exec -it sentinel-wazuh-manager cat /var/log/malware-drop-simulation.log
```

## Troubleshooting

### No FIM Alerts Appearing
```bash
# Check if directory is monitored
docker exec -it sentinel-wazuh-manager grep -A 5 -B 5 "fimtest" /var/ossec/etc/ossec.conf

# Restart syscheck
docker exec -it sentinel-wazuh-manager /var/ossec/bin/wazuh-control restart
```

### VirusTotal Not Working
```bash
# Check VirusTotal integration status
docker exec -it sentinel-wazuh-manager grep -i virustotal /var/ossec/logs/ossec.log

# Verify API key configuration
docker exec -it sentinel-wazuh-manager grep -A 10 -B 10 virustotal /var/ossec/etc/ossec.conf
```

### Files Not Being Created
```bash
# Check directory permissions
docker exec -it sentinel-wazuh-manager ls -ld /var/ossec/data/fimtest/

# Fix permissions if needed
docker exec -it sentinel-wazuh-manager chown wazuh:wazuh /var/ossec/data/fimtest/
```

## Integration with SOC Workflow

### Alert Triage Process
1. **FIM Alert** → Investigate file creation event
2. **Hash Analysis** → Check VirusTotal results
3. **Context Review** → Assess file location and name
4. **Response Action** → Quarantine if malicious

### Expected Dashboard Metrics
- **File Creation Timeline** → Visualize when files were dropped
- **VirusTotal Detection Rate** → Show malicious vs clean ratio
- **File Type Distribution** → Track executable vs document files
- **Hash Reputation** → Display known good vs bad files

This simulation provides realistic malware detection scenarios for SOC analyst training and system validation.